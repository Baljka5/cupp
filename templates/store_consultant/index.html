{% extends "base.html" %}
{% load event_tags %}
{% load widget_tweaks %}

{% block header %}
{% endblock %}

{% block content %}
    <div class="content">
        <div class="dropdown-section">
            <div class="dropdown-container">
                <label for="year-select">YEAR</label>
                <select id="year-select" name="year">
                    <option value="2023">2024</option>
                    <option value="2024">2025</option>
                    <!-- Additional years as needed -->
                </select>
            </div>
            <div class="dropdown-container">
                <label for="month-select">MONTH</label>
                <select id="month-select" name="month">
                    <option value="jan">JAN</option>
                    <option value="feb">FEB</option>
                    <option value="mar">MAR</option>
                    <!-- Additional months as needed -->
                </select>
            </div>
        </div>

        <div class="teams-container">
            <div class="team-row">
                {% for area in areas %}
                    <div class="team" onclick="showTeamDetails('{{ area.id }}', '{{ area.team_no }}')">
                        <div class="team-header">{{ area.team_no }}<span class="sc-count"></span></div>
                        <div class="team-body" id="area-{{ area.id }}" ondrop="drop(event)"
                             ondragover="allowDrop(event)"
                             data-area-id="{{ area.id }}">

                            {#                        <div class="team-body" ondrop="drop(event)" ondragover="allowDrop(event)"#}
                            {#                             data-area-id="{{ area.id }}">#}
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div class="team-detail-container" id="team-detail-container">
                <!-- Team Details Will Be Populated Here -->
            </div>
            {#            <div class="not-allocated-body" ondrop="drop(event)" ondragover="allowDrop(event)"#}
            {#                 data-area-id="not-allocated">#}
            <div class="store-allocation-body" id="store-allocation" ondrop="drop(event)" ondragover="allowDrop(event)"
                 data-area-id="store-allocation">
                <div class="store-allocation">
                    <h2>SC Allocation (Not Allocated)</h2>
                    <!-- SCs will be dynamically added here via drag-and-drop -->
                </div>
            </div>
            <div class="not-allocated-body" id="not-allocated" ondrop="drop(event)" ondragover="allowDrop(event)"
                 data-area-id="not-allocated">

                <div class="not-allocated">
                    {% for consultant in consultants %}
                        <div class="sc" id="sc{{ consultant.id }}" draggable="true" ondragstart="drag(event)"
                             data-consultant-id="{{ consultant.id }}">
                            {{ consultant.sc_name }}
                        </div>
                    {% endfor %}
                </div>
            </div>
            {#            <div class="store-allocation-body" id="store-allocation" ondrop="drop(event)" ondragover="allowDrop(event)"#}
            {#                 data-area-id="store-allocation">#}
            {#                <div class="store-allocation">#}
            {#                    <h2>Store Allocation (Not Allocated)</h2>#}
            {#                    <!-- SCs will be dynamically added here via drag-and-drop -->#}
            {#                </div>#}
            {#            </div>#}
            {#            <div class="not-allocated-body" id="not-allocated" ondrop="drop(event)" ondragover="allowDrop(event)"#}
            {#                 data-area-id="not-allocated">#}
            {##}
            {#                <div class="not-allocated">#}
            {#                    {% for store_consultant in store_consultants %}#}
            {#                        <div class="sc" id="sc{{ store_consultant.id }}" draggable="true" ondragstart="drag(event)"#}
            {#                             data-consultant-id="{{ store_consultant.id }}">#}
            {#                            {{ store_consultant.store_id }}#}
            {#                        </div>#}
            {#                    {% endfor %}#}
            {#                </div>#}
            {#            </div>#}
            <div class="save-close-container">
                {#                <button id="saveCloseBtn">SAVE & CLOSE</button>#}
                <button id="saveCloseBtn" onclick="saveAllocations()">SAVE & CLOSE</button>
            </div>
        </div>
    </div>
    <style>
        .teams-container {
            display: flex;
            flex-direction: column;
            margin: 0 20px;
        }

        .team-row {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .team {
            background-color: #D1D0CF;
            padding: 10px;
            margin-bottom: 20px;
            flex: 1;
            margin-left: 20px;
            display: flex;
            flex-direction: column; /* Ensure .team-header can take full width */
        }

        .team:first-child {
            margin-left: 0;
        }

        .team-header {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between; /* Align items on opposite ends */
            align-items: center; /* Center items vertically */
            width: 100%; /* Ensure it spans the full width of .team */
        }

        .team-body {
            background-color: #F4E2D0;
            padding: 10px;
            margin: 5px 0; /* Adjusted for demonstration */
        }

        .sc {
            background-color: #ffcc99;
            padding: 5px;
            margin: 5px 5px;
        }

        .not-allocated-body {
            background-color: #D1D0CF;
            padding: 10px;
            margin: 5px;
        }

        .not-allocated {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .save-close-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        #saveCloseBtn {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        .dropdown-section {
            display: flex;
            justify-content: start;
            margin-bottom: 20px; /* Adjust as needed */
        }

        .dropdown-container {
            margin-right: 20px; /* Adjust space between dropdowns as needed */
        }

        .dropdown-container select {
            display: block;
            width: 100%; /* Adjust width as needed */
            padding: 5px;
            margin-top: 5px; /* Adjust as needed */
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f8f8f8;
        }

        .dropdown-container label {
            display: block;
            text-align: center;
            background-color: #666; /* Adjust color as needed */
            color: white;
            padding: 5px;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .team-details {
            display: flex;
            flex-direction: column;
            padding: 10px;
            margin-top: 20px;
            background-color: #f4e2d0; /* Match your color scheme */
        }

        .sc-detail {
            background-color: #ffcc99;
            margin: 5px 0;
            padding: 5px;
        }

        .stores-detail span {
            margin-right: 10px;
            /* Additional styling as needed */
        }

        .team.highlighted {
            background-color: #add8e6; /* Light blue, for example */
            /* Other styles for highlighted team */
        }

        /* Hidden by default */
        .team-detail-container {
            display: none;
        }

        /* Visible when a team is clicked */
        .team-detail-container.visible {
            display: block;
            /* Other styles to make it visible */
        }
    </style>

    <script>
        function highlightTeam(teamId) {
            // Remove existing highlights
            document.querySelectorAll('.team').forEach(team => {
                team.classList.remove('highlighted');
            });

            // Highlight the selected team
            const selectedTeam = document.getElementById(`team-${teamId}`);
            selectedTeam.classList.add('highlighted');
        }

        // Function to show team details and distribution
        function showTeamDetails(teamId) {
            const detailContainer = document.getElementById('team-detail-container');
            detailContainer.innerHTML = ''; // Clear previous details
            detailContainer.classList.add('visible'); // Make the container visible

            // Fetch the data for the selected team
            fetch(`/get-team-data/${teamId}/`)
                .then(response => response.json())
                .then(data => {
                    // Your existing logic to create the details view

                    // After fetching and creating elements for team details
                    highlightTeam(teamId); // Call the function to highlight the team
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // Event listeners for teams
        document.querySelectorAll('.team').forEach(team => {
            team.addEventListener('click', function () {
                showTeamDetails(this.dataset.teamId);
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            const teams = document.querySelectorAll('.team');
            teams.forEach(team => {
                team.addEventListener('click', function () {
                    showTeamDetails(this.dataset.areaId); // this assumes your team divs have data-area-id attributes
                });

                // Initially fetch and render allocations, then update SC counts
                fetchAllocationsAndRender().then(updateScCounts);
            });
        });

        function fetchAllocationsAndRender() {
            return fetch('/get-allocations/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    data.forEach(allocation => {
                        const consultantElement = document.getElementById(`sc${allocation.consultant__id}`);
                        const areaElement = document.querySelector(`[data-area-id="${allocation.area__id}"]`);
                        if (consultantElement && areaElement) {
                            const targetContainer = areaElement.querySelector('.team-body') || areaElement;
                            targetContainer.appendChild(consultantElement);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching allocations:', error);
                });
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function drag(event) {
            event.dataTransfer.setData("text", event.target.id);
        }

        function drop(event) {
            event.preventDefault();
            const data = event.dataTransfer.getData("text");
            const consultantElement = document.getElementById(data);
            let target = event.target;

            // Ensure we're dropping the consultant into a valid area or back to the not-allocated container
            if (!target.classList.contains('team-body')) {
                target = target.closest('.team-body, .not-allocated-body');
            }

            if (target) {
                target.appendChild(consultantElement);
                updateScCounts(); // Update the SC counts after each drop operation
                saveCurrentStateToLocal(); // Save the current state to local storage
            }
        }

        function saveCurrentStateToLocal() {
            const allocations = [];
            document.querySelectorAll('.team-body, .not-allocated-body').forEach(area => {
                const areaId = area.getAttribute('data-area-id') || 'not-allocated';
                area.querySelectorAll('.sc').forEach(consultant => {
                    allocations.push({
                        consultantId: consultant.getAttribute('data-consultant-id'),
                        areaId: areaId
                    });
                });
            });
            localStorage.setItem('allocations', JSON.stringify(allocations));
        }

        function saveAllocations() {
            const allocations = JSON.parse(localStorage.getItem('allocations')) || [];
            fetch('/save-allocations/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({allocations})
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok.');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Success:', data);
                    alert('Allocations saved successfully!');
                    localStorage.removeItem('allocations'); // Clear local storage after successful save
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to save the allocations. Please try again.');
                });
        }

        function updateScCounts() {
            document.querySelectorAll('.team').forEach(team => {
                const count = team.querySelectorAll('.sc').length;
                team.querySelector('.sc-count').textContent = ` (${count} SC${count !== 1 ? 's' : ''})`;
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

{% endblock %}
