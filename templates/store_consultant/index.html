{% extends "base.html" %}
{% load event_tags %}
{% load widget_tweaks %}

{% block header %}
    <!-- You can add specific header content here if needed, such as a page title -->
{% endblock %}

{% block content %}
    <div class="content">
        <div class="teams-container">
            <div class="team-row">
                {% for area in areas %}
                    <div class="team">
                        <div class="team-header">{{ area.team_no }}</div>
                        <!-- Make team-body a drop zone -->
                        <div class="team-body" ondrop="drop(event)" ondragover="allowDrop(event)"
                             data-area-id="{{ area.id }}">
                            <!-- Your code for displaying team consultants goes here -->
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div class="not-allocated-body"  ondrop="drop(event)" ondragover="allowDrop(event)"
                     data-area-id="not-allocated">
                <div class="not-allocated">
                    {% for consultant in consultants %}
                        <!-- Make sc elements draggable -->
                        <div class="sc" id="sc{{ consultant.id }}" draggable="true" ondragstart="drag(event)"
                             data-consultant-id="{{ consultant.id }}">
                            {{ consultant.sc_name }}
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="save-close-container">
                <button id="saveCloseBtn">SAVE & CLOSE</button>
            </div>
        </div>
    </div>
    <style>
        .teams-container {
            display: flex;
            flex-direction: column;
            margin: 0 20px;
        }

        .team-row {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .team {
            background-color: #D1D0CF;
            padding: 10px;
            margin-bottom: 20px;
            flex: 1;
            margin-left: 20px;
        }

        .team:first-child {
            margin-left: 0;
        }

        .team-body {
            background-color: #F4E2D0;
            padding: 10px;
            margin: 5px;
        }

        .team-header {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .sc {
            background-color: #ffcc99;
            padding: 5px;
            margin: 5px 5px;

        }

        .not-allocated-body {
            background-color: #D1D0CF;
            padding: 10px;
            margin: 5px;
        }

        .not-allocated {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .save-close-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        #saveCloseBtn {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

    </style>

    <script>
        function allowDrop(event) {
            event.preventDefault(); // Necessary to allow dropping
        }

        function drag(event) {
            event.dataTransfer.setData("text", event.target.id); // Set the id of the drag source
        }

        function drop(event) {
            event.preventDefault();
            var data = event.dataTransfer.getData("text");
            var consultantElement = document.getElementById(data);
            var consultantId = consultantElement.getAttribute('data-consultant-id');
            var target = event.target;

            // Determine whether the drop target is a team body or the not-allocated section
            var targetIsTeamBody = target.classList.contains('team-body');
            var targetIsNotAllocated = target.classList.contains('not-allocated') || target.id === 'not-allocated';
            var targetAreaId = target.getAttribute('data-area-id') || (targetIsNotAllocated ? 'not-allocated' : null);

            // Append the consultant to the new team or back to not-allocated
            if (targetIsTeamBody || targetIsNotAllocated) {
                target.appendChild(consultantElement);
            } else {
                // If the drop target is not a team body or not-allocated, find the closest matching parent
                var closestTarget = target.closest('.team-body, .not-allocated');
                if (closestTarget) {
                    closestTarget.appendChild(consultantElement);
                    targetAreaId = closestTarget.getAttribute('data-area-id') || 'not-allocated';
                }
            }

            // Make an AJAX call to update the backend
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/update-consultant-area/', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
            xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken')); // Assuming you have a function to get cookies
            xhr.send('consultantId=' + consultantId + '&targetAreaId=' + targetAreaId);

            xhr.onload = function () {
                if (xhr.status === 200) {
                    console.log('Consultant updated successfully');
                    // Additional success logic here
                } else {
                    console.error('Error updating consultant');
                    // Additional error handling here
                }
            };
        }

        // Function to get the value of a cookie by name for CSRF token
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

{% endblock %}
