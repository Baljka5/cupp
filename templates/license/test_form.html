{% extends "base.html" %}
{% load widget_tweaks %}
{% load event_tags %}

{% block content %}
    <div class="content">
        <!-- Form for Enter Details (MainTableForm) -->
        <form method="post" autocomplete="off" enctype="multipart/form-data" id="main_form" class="post-form"
              action="/addnew">
            {% csrf_token %}
            <div class="row">
                <div class="container">
                    <div class="col-12">
                        {% if messages %}
                            <div class="container mt-3">
                                {% for message in messages %}
                                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    {% is_in_license_group as user_in_license_group %}
                    {% if user_in_license_group %}
                        <h3>Enter Details</h3>
                        <div class="form-group col-md-6">
                            <label>Store code: <span class="text-purple">*</span></label>
                            {% render_field form.store_id class+="form-control" %}
                        </div>

                        <div class="form-group col-md-6">
                            <label>Лицензийн төрөл: <span class="text-purple">*</span></label>
                            <select id="id_lic_id" class="form-control" name="lic_id">
                                <option value="" disabled selected>------</option>
                                {% for lic_id, lic_id_nm in lic_id_to_name.items %}
                                    <option value="{{ lic_id }}" data-name="{{ lic_id_nm }}">{{ lic_id }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label>Лицензийн төрлийн нэр: <span class="text-purple">*</span></label>
                            <input id="id_lic_id_nm" class="form-control" name="lic_id_nm" readonly type="text">
                        </div>
                        <div class="form-group col-md-6">
                            <label>Лицензтэй эсэх: <span class="text-purple">*</span></label>
                            {% render_field form.lic_yn class+="form-control" %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>Лиценз авсан огноо: <span class="text-purple">*</span></label>
                            {% render_field form.st_dt class+="form-control" %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>Лиценз дуусах огноо: <span class="text-purple">*</span></label>
                            {% render_field form.ed_dt class+="form-control" %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>Лиценз авсан ажилтан: <span class="text-purple">*</span></label>
                            {% render_field form.lic_owner class+="form-control" %}
                        </div>
                        <div class="form-group col-md-6 liquor-time" style="display: none;">
                            <label>Архи зарж эхлэх цаг: <span class="text-purple">*</span></label>
                            <input type="time" id="id_alc_opentime" name="alc_opentime" class="form-control"
                                   value="{{ form.alc_opentime.value|default_if_none:"" }}">
                        </div>
                        <div class="form-group col-md-6 liquor-time" style="display: none;">
                            <label>Архи зарж дуусах цаг: <span class="text-purple">*</span></label>
                            <input type="time" id="id_alc_closetime" name="alc_closetime" class="form-control"
                                   value="{{ form.alc_closetime.value|default_if_none:"" }}">
                        </div>
                        <div class="form-group col-md-6 camera-count" style="display: none;">
                            <label>Камерын тоо: <span class="text-purple">*</span></label>
                            <input type="number" id="id_camera_cnt" name="camera_cnt" class="form-control"
                                   value="{{ form.camera_cnt.value|default_if_none:"" }}">
                        </div>
                        <div class="form-group col-md-6 field-size" style="display: none;">
                            <label>Талбайн хэмжээ: <span class="text-purple">*</span></label>
                            <input type="number" id="id_lic_sqrm" name="lic_sqrm" class="form-control"
                                   value="{{ form.lic_sqrm.value|default_if_none:"" }}">
                        </div>
                        <div class="form-group col-md-6">
                            <label>Лиценз олгосон газрын нэр ID: </label>
                            {% render_field form.lic_prov_ID class+="form-control" %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>Лиценз олгосон газар: </label>
                            {% render_field form.lic_prov_name class+="form-control" %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>Лицензийн код: </label>
                            {% render_field form.lic_no class+="form-control" %}
                        </div>
                        <div class="form-group col-md-6 liquor-time">
                            <label>Архины төрөл: <span class="text-purple">*</span></label>
                            {% render_field form.alc_type class+="form-control" id='id_alc_type' %}
                        </div>
                        <div class="form-group col-md-6 liquor-time">
                            <label>Зөвшөөрлийн төрөл: <span class="text-purple">*</span></label>
                            {% render_field form.lic_type class+="form-control" id='id_lic_type' %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>Зөвшөөрөл байршиж буй холбоос /sharepoint холбоос/: <span
                                    class="text-purple">*</span></label>
                            {% render_field form.link_path class+="form-control" %}
                        </div>
                        <div class="form-group col-md-6 liquor-time">
                            <label>Лиценз авсан /Хот, Дүүрэг, Аймаг/: <span class="text-purple">*</span></label>
                            {% render_field form.district class+="form-control" id='id_district' %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>Лицензын төлөв: <span class="text-purple">*</span></label>
                            {% render_field form.lic_status class+="form-control" %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>Зөвшөөрлийн нийт хугацаа: <span class="text-purple">*</span></label>
                            {% render_field form.lic_duration class+="form-control" %}
                        </div>
                        <div class="mb-3">
                            <a href="{% url 'index' %}" class="btn btn-link text-purple-300">
                                Cancel
                            </a>
                            <div class="mb-3">
                                <button type="submit" name="save_main" class="btn btn-primary">Save Main Details
                                </button>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </form>

        <!-- Form for Dispute Enter Details (DisputeForm) -->
        <form method="post" autocomplete="off" enctype="multipart/form-data" id="dispute_form" class="post-form"
              action="/addnew">
            {% csrf_token %}
            <div class="row">
                <div class="container">
                    {% if user_in_legal_team_group %}
                        <h3>Dispute Enter Details</h3>
                        <div class="form-group col-md-6">
                            <label>Бодит үйл явдал болсон огноо:</label>
                            {% render_field dispute_form.date class+="form-control" id="id_date" %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>Дэлгүүрийн дугаар: <span class="text-purple">*</span></label>
                            <select id="id_store_no" class="form-control" name="store_no">
                                <option value="" disabled selected>Select Store ID</option>
                                {% for store_id, store_name in store_id_to_name.items %}
                                    <option value="{{ store_id }}" data-name="{{ store_name }}">{{ store_id }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label>Дэлгүүрийн нэр: <span class="text-purple">*</span></label>
                            <input id="id_store_name" class="form-control" name="store_name" readonly type="text">
                        </div>
                        <div class="form-group col-md-6">
                            <label>Болсон хэргийн талаар дэлгэрэнгүй мэдээлэл:</label>
                            {% render_field dispute_form.disp_desc class+="form-control" %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>Хэргийн төрөл:</label>
                            {% render_field dispute_form.disp_cat class+="form-control" %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>Хохирлын хэмжээ/ мөнгөн дүн:</label>
                            {% render_field dispute_form.dmg_amt class+="form-control" %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>Хохирлын хэмжигдэхүүн:</label>
                            {% render_field dispute_form.dmg_uom class+="form-control" %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>Хариуцсан алба нэгж:</label>
                            {% render_field dispute_form.disp_owner class+="form-control" id='id_disp_owner' %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>Хэргийн төлөв:</label>
                            {% render_field dispute_form.disp_status class+="form-control" %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>Хэргийн явц:</label>
                            {% render_field dispute_form.disp_progress class+="form-control" %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>Хэрэг шийдэгдсэн эсэх:</label>
                            {% render_field dispute_form.disp_result class+="form-control" %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>Хэрэг шийдэгдсэн өдөр:</label>
                            {% render_field dispute_form.close_date class+="form-control" id="id_close_date" %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>Холбогдох баримт бичгийн холбоос:</label>
                            {% render_field dispute_form.supp_link class+="form-control" %}
                        </div>
                        <div class="mb-3">
                            <a href="{% url 'index' %}" class="btn btn-link text-purple-300">
                                Cancel
                            </a>
                            <div class="mb-3">
                                <button type="submit" name="save_dispute" class="btn btn-primary">Save Dispute</button>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.13.18/jquery.timepicker.min.js"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.13.18/jquery.timepicker.min.css"/>
    <script>
        $(document).ready(function () {
            // Function to show or hide fields
            function toggleLiquorTimeFields() {
                var licType = $('#id_lic_id').val();
                // Check if the selected license type is '02'
                if (licType === '02') {
                    // Show the fields
                    $('.liquor-time').show();
                    $('#id_alc_opentime, #id_alc_closetime, #id_alc_type, #id_lic_type').prop('required', true);
                } else {
                    // Hide the fields and clear any selected values if not type '02'
                    $('.liquor-time').hide();
                    $('#id_alc_opentime, #id_alc_closetime, #id_alc_type, #id_lic_type').prop('required', false).val('');
                }
                if (licType === '07') {
                    $('.camera-count').show();
                    $('#id_camera_cnt').prop('required', true);
                } else {
                    $('.camera-count').hide();
                    $('#id_camera_cnt').prop('required', false).val('');// Clear value if not type '07'
                }
                if (licType === '03') {
                    $('.field-size').show();
                    $('#id_lic_sqrm').prop('required', true);
                } else {
                    $('.field-size').hide();
                    $('#id_lic_sqrm').prop('required', false).val('');// Clear value if not type '03'
                }
            }

            // Initial check in case of form re-render with selected value
            toggleLiquorTimeFields();

            // Change event for license type dropdown
            $('#id_lic_id').change(function () {
                var selectedName = $(this).find('option:selected').data('name');
                $('#id_lic_id_nm').val(selectedName);
                $('#id_lic_id_nm').prop('readonly', true);

                // Call the toggle function upon changing the license type
                toggleLiquorTimeFields();
            });

            $('#id_st_dt, #id_ed_dt').daterangepicker({
                singleDatePicker: true,
                applyClass: 'bg-purple btn-sm',
                cancelClass: 'btn-light btn-sm',
                locale: {
                    format: 'YYYY/MM/DD'
                }
            });
            $('#id_date, #id_close_date').daterangepicker({
                singleDatePicker: true,
                applyClass: 'bg-purple btn-sm',
                cancelClass: 'btn-light btn-sm',
                locale: {
                    format: 'YYYY/MM/DD'
                }
            });
            $('#id_store_no').select2({
                width: '100%',
                placeholder: "Select a Store ID",
            });

            // Update store_name when store_no is selected
            $('#id_store_no').change(function () {
                var selectedName = $(this).find('option:selected').data('name');
                $('#id_store_name').val(selectedName);
                $('#id_store_name').prop('readonly', true);
            });
        });
    </script>


{% endblock %}
